# PeSIT Wizard Server Configuration
# Profile: PeSIT Hors-SIT over TCP/IP
#
# Database profiles:
#   - default (H2): For local development
#   - postgres: For production with PostgreSQL (multi-tenant)
#
# Run with: --spring.profiles.active=postgres
# Set PESIT_CLUSTER_ID for multi-tenant mode

spring:
  application:
    name: pesitwizard-server
  
  # Default: H2 Database configuration (for local development)
  datasource:
    url: jdbc:h2:file:./data/pesitwizard-db;DB_CLOSE_DELAY=-1
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  
  # JPA configuration
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    open-in-view: false
    defer-datasource-initialization: true

  # SQL initialization - disabled, use API instead
  # sql:
  #   init:
  #     mode: always
  #     data-locations: classpath:data.sql
  #     continue-on-error: true
  
  # H2 Console (for debugging, only in default profile)
  h2:
    console:
      enabled: true
      path: /h2-console

# Server configuration
server:
  port: 8080  # HTTP management port (REST API)

# PeSIT Protocol Configuration
pesit:
  # Version info (injected at build time)
  version: "@project.version@"
  build:
    timestamp: "@maven.build.timestamp@"
    commit: "${GIT_COMMIT:dev}"
  
  # Multi-tenant cluster configuration
  cluster:
    # Cluster ID for multi-tenant mode (set via VECTIS_CLUSTER_ID env var)
    # When set, server uses cluster-specific schema in PostgreSQL
    id: ${VECTIS_CLUSTER_ID:}
    
    # Enable JGroups cluster mode for HA
    enabled: false
    # Node name (auto-generated if not set)
    # node-name: node1
    # JGroups configuration file (udp.xml for multicast, tcp.xml for unicast)
    config: udp.xml
  
  # TLS/SSL Configuration
  ssl:
    # Enable TLS for PeSIT protocol (env: PESIT_SSL_ENABLED)
    enabled: ${PESIT_SSL_ENABLED:false}
    # Keystore name (from database) - required if enabled
    keystore-name: ${PESIT_SSL_KEYSTORE_NAME:default-keystore}
    # Truststore name (from database) - required for mTLS
    truststore-name: ${PESIT_SSL_TRUSTSTORE_NAME:pesit-ca-truststore}
    # Client authentication mode for mTLS (env: PESIT_SSL_CLIENT_AUTH)
    client-auth: ${PESIT_SSL_CLIENT_AUTH:NONE}
    # TLS protocol version (TLSv1.2, TLSv1.3)
    protocol: ${PESIT_SSL_PROTOCOL:TLSv1.3}
    # Verify client certificate chain against CA
    verify-certificate-chain: true
    # Enabled cipher suites (empty = use defaults)
    cipher-suites: []
    # Environment variable based certificates (for Kubernetes deployments)
    keystore-data: ${PESIT_SSL_KEYSTORE_DATA:}
    keystore-password: ${PESIT_SSL_KEYSTORE_PASSWORD:}
    ca-cert-pem: ${PESIT_SSL_CA_CERT_PEM:}
  
  # Private Certificate Authority Configuration
  ca:
    # Enable the private CA functionality
    enabled: true
    # CA keystore name in database
    ca-keystore-name: pesit-ca-keystore
    # CA truststore name in database (for distribution to clients)
    ca-truststore-name: pesit-ca-truststore
    # CA key alias
    ca-key-alias: pesit-ca
    # CA keystore password (use env var in production)
    ca-keystore-password: ${PESIT_CA_PASSWORD:changeit}
    # CA truststore password
    ca-truststore-password: ${PESIT_CA_TRUSTSTORE_PASSWORD:changeit}
    # CA certificate validity (days) - default 10 years
    ca-validity-days: 3650
    # Default certificate validity (days) - default 1 year
    default-cert-validity-days: 365
    # Key size for generated keys
    key-size: 2048
    # CA Subject DN components
    ca-common-name: PeSIT Private CA
    organization: PeSIT Wizard
    organizational-unit: Certificate Authority
    locality: Paris
    state: IDF
    country: FR
  
  server:
    # TCP port for Vectis protocol
    port: 5000
    # TLS port for Vectis protocol (when SSL enabled)
    tls-port: 5001
    
    # Server identifier (PI 4) - max 8 characters
    server-id: PESITSRV
    
    # Protocol version (PI 6) - 2 for Hors-SIT
    protocol-version: 2
    
    # Maximum concurrent connections
    max-connections: 100
    
    # Connection timeout (ms)
    connection-timeout: 30000
    
    # Read timeout (ms)
    read-timeout: 60000
    
    # Default directory for received files (used if no logical file match)
    receive-directory: ./received
    
    # Default directory for files to send (used if no logical file match)
    send-directory: ./send
    
    # Maximum entity size (PI 25) in bytes
    max-entity-size: 4096
    
    # Enable sync points (PI 7)
    sync-points-enabled: true
    
    # Enable resynchronization (PI 23)
    resync-enabled: true
    
    # Require partner to be configured (if false, unknown partners are allowed)
    strict-partner-check: true
    
    # Require logical file to be configured (if false, any filename is allowed)
    strict-file-check: true
    
    # ===== PARTNER CONFIGURATION =====
    # Partners are remote systems that can connect to this server
    # Key is used for lookup, 'id' field should match PI 3 (Demandeur)
    partners:
      # Integration test client
      LOOP:
        id: LOOP
        description: Integration test client
        enabled: true
        password: ""
        access-type: BOTH
        max-connections: 10
        allowed-files: []
      
      # Example partner (8 chars max, uppercase alphanumeric only)
      TESTCLI:
        id: TESTCLI
        description: Test client for development
        enabled: true
        password: ""  # Empty = no password required
        access-type: BOTH  # READ, WRITE, or BOTH
        max-connections: 10
        allowed-files: []  # Empty = all files allowed

      # IBM CX Client (8 chars max)
      CXCLIENT:
        id: CXCLIENT
        description: IBM Sterling Connect:Express client
        enabled: true
        password: test123
        access-type: BOTH
        max-connections: 10
        allowed-files: []

      # Example partner with password (8 chars max)
      SECUREP:
        id: SECUREP
        description: Partner requiring authentication
        enabled: true
        password: secret123
        access-type: WRITE
        max-connections: 5
        allowed-files:
          - INCOMING
          - DATAFILE

      # Example disabled partner (8 chars max)
      DISABLED:
        id: DISABLED
        description: Temporarily disabled partner
        enabled: false
    
    # ===== LOGICAL FILE CONFIGURATION =====
    # Logical files map virtual filenames to local paths
    # Key is the filename pattern (supports * wildcard)
    files:
      # Integration test file (used by CompleteFileTransferTest)
      FILE:
        id: FILE
        description: Integration test file
        enabled: true
        direction: BOTH
        receive-directory: ./received/test
        send-directory: ./send/test
        receive-filename-pattern: "${virtualfile}_${timestamp}"
        overwrite: true
      
      # Alternative test file
      TESTFILE:
        id: TESTFILE
        description: Alternative test file
        enabled: true
        direction: BOTH
        receive-directory: ./received/test
        send-directory: ./send/test
        receive-filename-pattern: "${virtualfile}_${timestamp}"
        overwrite: true
      
      # Sync point test files
      SYNCTEST:
        id: SYNCTEST
        enabled: true
        direction: BOTH
        receive-directory: ./received/test
      IDTTEST:
        id: IDTTEST
        enabled: true
        direction: BOTH
        receive-directory: ./received/test
      RESTART:
        id: RESTART
        enabled: true
        direction: BOTH
        receive-directory: ./received/test
      
      # Example: Incoming data files (8 chars max, no underscore)
      INCOMING:
        id: INCOMING
        description: Incoming data files from partners
        enabled: true
        direction: RECEIVE  # RECEIVE, SEND, or BOTH
        receive-directory: ./received/incoming
        receive-filename-pattern: "${virtualfile}_${timestamp}"
        overwrite: false
        max-file-size: 104857600  # 100 MB

      # Example: Outgoing reports (8 chars max, no wildcard in ID)
      REPORTS:
        id: REPORTS
        description: Outgoing report files
        enabled: true
        direction: SEND
        send-directory: ./send/reports

      # Example: Bidirectional file (8 chars max, no underscore)
      EXCHANGE:
        id: EXCHANGE
        description: Bidirectional exchange file
        enabled: true
        direction: BOTH
        receive-directory: ./received/exchange
        send-directory: ./send/exchange
        receive-filename-pattern: "${virtualfile}_${date}"
        overwrite: true
    
    # Enable CRC checking (PI 1)
    crc-enabled: false

# Security Configuration
pesit.security:
  # Enable security (set to false to disable all authentication)
  # WARNING: Must be true in production!
  enabled: ${PESIT_SECURITY_ENABLED:true}
  
  # Authentication mode: oauth2, apikey, basic, or mixed
  mode: mixed
  
  # OAuth2/OIDC configuration (for SSO with Keycloak, Okta, Azure AD, etc.)
  oauth2:
    enabled: false
    # issuer-uri: https://your-idp.com/realms/your-realm
    # jwk-set-uri: https://your-idp.com/realms/your-realm/protocol/openid-connect/certs
    # audience: pesitwizard-server
    # client-id: pesitwizard-server
    username-claim: preferred_username
    roles-claim: roles
    alternative-roles-claims:
      - realm_access.roles
      - resource_access.${client_id}.roles
      - groups
  
  # API key configuration
  api-key:
    enabled: true
    header-name: X-API-Key
    query-param: api_key
    # Admin API key (set via env var for automated deployments)
    admin-key: ${PESIT_API_KEY_ADMIN:}
  
  # Basic auth (for development only - disable in production)
  basic-auth:
    enabled: ${PESIT_BASIC_AUTH_ENABLED:false}
    users:
      admin:
        password: ${PESIT_ADMIN_PASSWORD:changeme}
        roles:
          - ADMIN
      operator:
        password: ${PESIT_OPERATOR_PASSWORD:changeme}
        roles:
          - OPERATOR
      user:
        password: ${PESIT_USER_PASSWORD:changeme}
        roles:
          - USER
  
  # Public endpoints (no authentication required)
  public-endpoints:
    - /actuator/health
    - /actuator/health/**
    - /actuator/info
    # WARNING: h2-console must be disabled in production
    # - /h2-console/**
    # REMOVED: /api/v1/deployment/** - requires authentication
  
  # CORS configuration
  cors:
    enabled: true
    allowed-origins:
      - "*"
    allowed-methods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
    allowed-headers:
      - "*"
    allow-credentials: false
    max-age: 3600
  
  # Role mapping
  role-mapping:
    role-prefix: "ROLE_"
    default-roles:
      - USER
    # mappings:
    #   idp-admin: ADMIN
    #   idp-operator: OPERATOR

# Secrets Management
pesit.secrets:
  # Encryption key for secrets (Base64 encoded, 32 bytes for AES-256)
  # Generate with: openssl rand -base64 32
  # For production, set via environment variable: VECTIS_SECRETS_ENCRYPTION_KEY
  # encryption-key: ${VECTIS_SECRETS_ENCRYPTION_KEY:}

# Backup & Recovery
pesit.backup:
  # Directory for storing backups
  directory: ./backups
  # Retention period in days
  retention-days: 30
  # Maximum number of backups to keep
  max-backups: 10
  # Backup schedule (cron expression) - default: 1 AM daily
  schedule: "0 0 1 * * ?"

# File Integrity
pesit.integrity:
  # Hash algorithm: SHA-256, SHA-512, SHA-1, MD5
  algorithm: SHA-256
  # Re-verification interval in days
  verification-interval-days: 7
  # Buffer size for reading files (bytes)
  buffer-size: 8192

# Audit Logging
pesit.audit:
  # Retention period for audit events (days)
  retention-days: 365
  # Log audit events to console in JSON format (for SIEM integration)
  log-to-console: true

# Observability Configuration
pesit.observability:
  service-name: pesitwizard-server
  tracing:
    # Disabled by default - enable via API or set OTEL_EXPORTER_OTLP_ENDPOINT env var
    enabled: ${OTEL_ENABLED:false}
    endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:}
  metrics:
    enabled: true

# Actuator endpoints for monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
    prometheus:
      enabled: true
  metrics:
    tags:
      application: ${pesit.observability.service-name:pesitwizard-server}
    distribution:
      percentiles-histogram:
        http.server.requests: true
        pesitwizard.transfers.duration: true
  tracing:
    # Only enable if endpoint is configured
    enabled: ${pesit.observability.tracing.enabled:false}
    sampling:
      probability: 1.0

# Logging configuration
logging:
  level:
    root: INFO
    com.pesitwizard: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
